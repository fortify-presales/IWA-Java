# Create GitHub Action Repository Variables for your version of the application:
# - SSC_URL: URL of your Fortify Software Security Center instance (e.g. https://ssc.example.com)
# - SCANCENTRAL_VERSION: version of Fortify ScanCentral SAST sensor to use (e.g. 22.1.0)
# - SSC_APP_NAME_POSTFIX: optional postfix to append to the application name in SSC (e.g. -dev) to allow using different application names for different branches/environments
# - SSC_APPVERSION: name of the application version in SSC to use for the SAST scan (can be set dynamically in the workflow based on branch or pull request information, see Prepare job below)
# - SSC_PARENT_APPVERSION: name of the parent application version in SSC to use for the SAST scan (can be set dynamically in the workflow based on branch or pull request information, see Prepare job below)
# - SC_SAST_SENSOR_VERSION: version of the ScanCentral SAST sensor to use for SAST scan (e.g. 22.1.0)
# - SCDAST_SETTINGS_ID: ID of the ScanCentral DAST settings to use for DAST scan (can be found in the URL when you open the settings in SSC, e.g. if URL is https://ssc.example.com/
# Create GitHub Action Secrets for your version of the application:
# - SSC_TOKEN: API token for authenticating to your SSC instance (can be generated in your user profile in SSC)
# - SC_SAST_TOKEN: API token for authenticating to the ScanCentral SAST sensor (can be generated in your user profile in SSC)
# - DEBRICKED_TOKEN: API token for authenticating to Debricked (can be generated in your user profile in Debricked


name: OpenText ScanCentral SAST and DAST Scan

# Set default permissions for the GITHUB_TOKEN
permissions:
  contents: read
  pull-requests: write

on:
  # Triggers the workflow on push or pull request events but only for the main or develop branches
  #push:
  #  paths-ignore:
  #    - '.github/**/**'
  #    - 'Jenkinsfile'
  #    - '.gitlab-ci.yml'
  #    - 'azure-pipelines.yml'
  #    - 'bin/**'
  #    - 'data/**'
  #    - 'etc/**'
  #    - 'tests/**'
  #    - '*.md'
  #    - 'LICENSE'
  #  branches:
  #    - main
  #    - develop
  #    - feature/**    # runs on any branch named feature/...
  #    - bugfix/**     # runs on any branch named bugfix/...
  #pull_request:
  #  branches:
  #    - main
  #    - develop

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      runScanCentralSASTScan:
        description: 'Carry out SAST scan using Fortify ScanCentral'
        required: false
        default: 'false'
      runScanCentralDASTScan:
        description: 'Carry out DAST scan using Fortify ScanCentral'
        required: false
        default: 'false'

# Global environment variables
env:
  DEFAULT_APP_NAME: "IWA-Java"
  DEFAULT_PARENT_RELEASE_NAME: "main"
  GRADLE_VERSION: "7.6.4"
  JAVA_VERSION: "17"
  BASE_DIR: "."

jobs:

  #
  # The Prepare job is responsible for setting up the environment variables that will be used in the subsequent jobs.
  # It checks whether the workflow is running in the context of a pull request or a branch push and sets the SSC_APPVERSION
  # and SSC_PARENT_APPVERSION variables accordingly. For pull requests, it constructs the release name to indicate that
  # it's a merge to the base branch, while for branch pushes, it uses the branch name directly. This setup allows the
  # SAST and DAST scan jobs to reference the correct release information when they run.
  #
  Prepare:
    runs-on: ubuntu-latest
    outputs:
      SSC_APPVERSION: ${{ steps.commands.outputs.SSC_APPVERSION }}
      SSC_PARENT_APPVERSION: ${{ steps.commands.outputs.SSC_PARENT_APPVERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up environment variables
        id: commands
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "Running in a pull request pipeline ..."
            echo "SSC_APPVERSION=${{ env.DEFAULT_APP_NAME }}${{ vars.SSC_APP_NAME_POSTFIX }}:merge-to-${{ github.base_ref }}#PR${{ github.event.number }}" >> $GITHUB_OUTPUT
            echo "SSC_PARENT_APPVERSION=${{ env.DEFAULT_APP_NAME }}${{ vars.SSC_APP_NAME_POSTFIX }}:${{ github.head_ref }}" >> $GITHUB_OUTPUT
          else
            echo "Running in a branch pipeline ..."
            echo "SSC_APPVERSION=${{ env.DEFAULT_APP_NAME }}${{ vars.SSC_APP_NAME_POSTFIX }}:${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "SSC_PARENT_APPVERSION=${{ env.DEFAULT_APP_NAME }}${{ vars.SSC_APP_NAME_POSTFIX }}:${{ env.DEFAULT_PARENT_RELEASE_NAME }}" >> $GITHUB_OUTPUT
          fi 

  ScanCentral-SAST-Scan:
    runs-on: ubuntu-latest
    if: ${{ (github.event_name == 'push') || (github.event_name == 'pull_request') || (github.event.inputs.runScanCentralSASTScan == 'true') }}
    needs: [ Prepare ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      # Setup JDK 17 on host
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      #
      # See: https://github.com/marketplace/actions/fortify-ast-scan
      #
      - name: Run ScanCentral SAST Scan
        uses: fortify/github-action@v2
        with:
          sast-scan: true
          debricked-scan: true
        env:
          SSC_URL: ${{ vars.SSC_URL }}
          SSC_TOKEN: ${{ secrets.SSC_TOKEN }}
          SC_SAST_TOKEN: ${{ secrets.SC_SAST_TOKEN }}
          #SSC_APPVERSION: ${{ format('{0}:{1}', steps.fortify-app-and-rel-name.outputs.app_name, steps.fortify-app-and-rel-name.outputs.release_name) }}
          SC_SAST_SENSOR_VERSION: ${{ vars.SC_SAST_SENSOR_VERSION }}
          DO_SETUP: true
          DEBRICKED_TOKEN: ${{ secrets.DEBRICKED_TOKEN }}
          DO_WAIT: true
          SAST_WAIT_EXTRA_OPTS: --timeout 2h
          DO_POLICY_CHECK: false  # we will do policy check in a separate job after DAST scan
          DO_JOB_SUMMARY: true
          DO_PR_COMMENT: true
          DO_EXPORT: true

  ScanCentral-DAST-Scan:
    runs-on: ubuntu-latest
    if: ${{ (github.ref_name == github.event.repository.default_branch) && (github.event.inputs.runScanCentralDASTScan == 'true') }}
    needs: [ Prepare, ScanCentral-SAST-Scan ]
    env:
      SSC_APPVERSION: ${{ needs.Prepare.outputs.SSC_APPVERSION }}
      SSC_PARENT_APPVERSION: ${{ needs.Prepare.outputs.SSC_PARENT_APPVERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Fortify tools
        uses: fortify/github-action/setup@v2
        with:
          export-path: true
          fcli: latest
      - name: Run ScanCentral DAST Scan
        shell: bash
        run: |
          fcli ssc session login --url $SSC_URL -t $SSC_TOKEN --ssc-session github-actions
          fcli sc-dast scan start --settings "${SCDAST_SETTINGS_ID}" --store curScan --ssc-session github-actions
          sleep 10
          fcli sc-dast scan wait-for ::curScan:: --ssc-session github-actions
          fcli ssc session logout --ssc-session github-actions
        env:
          SSC_URL: ${{ vars.SSC_URL }}
          SSC_TOKEN: ${{ secrets.SSC_TOKEN }}
          SSC_APPVERSION: ${{ env.SSC_APPVERSION }}
          SCDAST_SETTINGS_ID: ${{ vars.SCDAST_SETTINGS_ID }}
  
  Verify-Security-Policy:
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: [ Prepare, ScanCentral-SAST-Scan ]
    env:
      SSC_APPVERSION: ${{ needs.Prepare.outputs.SSC_APPVERSION }}
      SSC_PARENT_APPVERSION: ${{ needs.Prepare.outputs.SSC_PARENT_APPVERSION }}
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Wait for ScanCentral-DAST-Scan to finish (if it started)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # This script polls the GitHub Actions API to check for the status of the FoD-DAST-Scan job in the current workflow run.
          # It waits until the job is no longer in progress before allowing the workflow to continue to the policy check step. 
          # This ensures that the policy check evaluates the results of the DAST scan if it was triggered.
          set -euo pipefail
          API="https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs"
          echo "Looking for job named 'ScanCentral-DAST-Scan' in this workflow run..."
          # install jq if missing
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y && sudo apt-get install -y jq
          fi
          # poll for the job status (max ~30 minutes)
          max_attempts=180
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt+1))
            job_json=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "$API")
            job_exists=$(echo "$job_json" | jq '.jobs[]? | select(.name=="ScanCentral-DAST-Scan")' || true)
            if [ -z "$job_exists" ] || [ "$job_exists" = "null" ]; then
              echo "No ScanCentral-DAST-Scan job found for this run. Proceeding."
              break
            fi
            status=$(echo "$job_json" | jq -r '.jobs[] | select(.name=="ScanCentral-DAST-Scan") | .status')
            conclusion=$(echo "$job_json" | jq -r '.jobs[] | select(.name=="ScanCentral-DAST-Scan") | .conclusion')
            echo "ScanCentral-DAST-Scan status: $status, conclusion: $conclusion"
            if [ "$status" = "completed" ]; then
              echo "ScanCentral-DAST-Scan completed (conclusion: $conclusion). Continuing."
              break
            fi
            echo "Waiting for ScanCentrla-DAST-Scan to finish... (attempt $attempt)"
            sleep 10
          done
          if [ $attempt -ge $max_attempts ]; then
            echo "Timed out waiting for ScanCentral-DAST-Scan; continuing anyway."
          fi
      - name: Run Check Policy Action
        continue-on-error: true # only for reporting, do not fail the job if policy check fails
        uses: fortify/github-action@v2
        with:
          sast-scan: false
          debricked-sca-scan: false
        env:
          SSC_URL: ${{ vars.SSC_URL }}
          SSC_TOKEN: ${{ secrets.SSC_TOKEN }}
          #SSC_APPVERSION: ${{ format('{0}:{1}', steps.fortify-app-and-rel-name.outputs.app_name, steps.fortify-app-and-rel-name.outputs.release_name) }}
          DO_SETUP: false
          DO_WAIT: false
          DO_POLICY_CHECK: true
          DO_JOB_SUMMARY: false
          DO_PR_COMMENT: true
          DO_EXPORT: true