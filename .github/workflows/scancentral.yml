# Create GitHub Action Repository Variables for your version of the application:
# - SSC_URL: URL of your Fortify Software Security Center instance (e.g. https://ssc.example.com)
# - AVIATOR_URL: URL of your Aviator instance (e.g. https://aviator.example.com)
# - SC_CLI_VERSION: version of the Fortify Software Security Center CLI to use for running the DAST scan (e.g. 22.1.0)
# - SSC_APPNAME_POSTFIX: optional postfix to append to the application name in SSC (e.g. -dev) to allow using different application names for different branches/environments
# - SCDAST_SETTINGS_ID: ID of the ScanCentral DAST settings to use for DAST scan (can be found in the URL when you open the settings in SSC, e.g. if URL is https://ssc.example.com/
# Create GitHub Action Secrets for your version of the application:
# - SSC_TOKEN: API token for authenticating to your SSC instance (can be generated in your user profile in SSC)
# - AVIATOR_TOKEN: API token for authenticating to Aviator (can be generated in your user profile in Aviator)
# - SC_SAST_TOKEN: API token for authenticating to the ScanCentral SAST sensor (can be generated in your user profile in SSC)
# - DEBRICKED_TOKEN: API token for authenticating to Debricked (can be generated in your user profile in Debricked
name: OpenText ScanCentral SAST and DAST Scan

# Set the permissions for the GITHUB_TOKEN to allow the workflow to read repository contents, write security events, and write pull request comments. This is necessary for the workflow to function properly, as it needs to access the codebase for scanning, report security findings, and comment on pull requests with the results.
permissions:
  contents: read
  security-events: write
  pull-requests: write

on:
  # Triggers the workflow on push or pull request events but only for the main or develop branches
  #push:
  #  paths-ignore:
  #    - '.github/**/**'
  #    - 'Jenkinsfile'
  #    - '.gitlab-ci.yml'
  #    - 'azure-pipelines.yml'
  #    - 'bin/**'
  #    - 'data/**'
  #    - 'etc/**'
  #    - 'tests/**'
  #    - '*.md'
  #    - 'LICENSE'
  #  branches:
  #    - main
  #    - develop
  #    - feature/**    # runs on any branch named feature/...
  #    - bugfix/**     # runs on any branch named bugfix/...
  #pull_request:
  #  branches:
  #    - main
  #    - develop

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      runScanCentralSASTScan:
        description: 'Carry out SAST scan using Fortify ScanCentral'
        required: false
        default: 'false'
      runScanCentralDASTScan:
        description: 'Carry out DAST scan using Fortify ScanCentral'
        required: false
        default: 'false'

# Global environment variables
env:
  DEFAULT_APP_NAME: "IWA-Java"
  DEFAULT_PARENT_APPVERSION_NAME: "main"
  GRADLE_VERSION: "7.6.4"
  JAVA_VERSION: "17"
  BASE_DIR: "."

jobs:

  #
  # The Prepare job is responsible for setting up the environment variables that will be used in the subsequent scan jobs.
  # It checks whether the workflow was triggered by a push to a branch or a pull request, and sets the SSC_APPVERSION and
  # SSC_PARENT_APPVERSION variables accordingly. For pull requests, it uses the source and target branches to create unique
  # application version names in SSC, while for branch pipelines it uses the branch name and a default parent version.
  # This allows for better organization of scan results in SSC based on the context of the scan (PR vs branch).
  Prepare:
    runs-on: ubuntu-latest
    outputs:
      SSC_APPVERSION: ${{ steps.commands.outputs.SSC_APPVERSION }}
      SSC_PARENT_APPVERSION: ${{ steps.commands.outputs.SSC_PARENT_APPVERSION }}
      AVIATOR_APP: ${{ steps.commands.outputs.AVIATOR_APP }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up environment variables
        id: commands
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "Running in a pull request pipeline ..."
            echo "SSC_APPVERSION=${{ env.DEFAULT_APP_NAME }}${{ vars.SSC_APPNAME_POSTFIX }}:merge-to-${{ github.base_ref }}#PR${{ github.event.number }}" >> $GITHUB_OUTPUT
            echo "SSC_PARENT_APPVERSION=${{ env.DEFAULT_APP_NAME }}${{ vars.SSC_APPNAME_POSTFIX }}:${{ github.head_ref }}" >> $GITHUB_OUTPUT
            echo "AVIATOR_APP=${{ env.DEFAULT_APP_NAME }}${{ vars.SSC_APPNAME_POSTFIX }}" >> $GITHUB_OUTPUT
          else
            echo "Running in a branch pipeline ..."
            echo "SSC_APPVERSION=${{ env.DEFAULT_APP_NAME }}${{ vars.SSC_APPNAME_POSTFIX }}:${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "SSC_PARENT_APPVERSION=${{ env.DEFAULT_APP_NAME }}${{ vars.SSC_APPNAME_POSTFIX }}:${{ env.DEFAULT_PARENT_APPVERSION_NAME }}" >> $GITHUB_OUTPUT
            echo "AVIATOR_APP=${{ env.DEFAULT_APP_NAME }}${{ vars.SSC_APPNAME_POSTFIX }}" >> $GITHUB_OUTPUT
          fi 

  #
  # The ScanCentral-SAST-Scan job runs the ScanCentral SAST and SCA scan using the fortify/github-action@v3 action.
  # It is triggered for both push and pull request events (as well as manually via workflow_dispatch) if the corresponding
  # input is set to true. It uses the environment variables set in the Prepare job to determine the application version
  # names in SSC, and it also passes the necessary tokens for authentication to SSC, Aviator, and Debricked. The scan is
  # configured to wait for completion, generate a summary, post a PR comment with the results, and export the results
  # for use in subsequent jobs.
  ScanCentral-SAST-Scan:
    runs-on: ubuntu-latest
    if: ${{ (github.event_name == 'push') || (github.event_name == 'pull_request') || (github.event.inputs.runScanCentralSASTScan == 'true') }}
    needs: [ Prepare ]
    env:
      SSC_APPVERSION: ${{ needs.Prepare.outputs.SSC_APPVERSION }}
      SSC_PARENT_APPVERSION: ${{ needs.Prepare.outputs.SSC_PARENT_APPVERSION }}
      AVIATOR_APP: ${{ needs.Prepare.outputs.AVIATOR_APP }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      # Setup JDK 17 on host
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      #
      # See: https://fortify.github.io/fcli/v3/ci/github/v3.0.x/ast-action-ssc.html
      #
      - name: Run ScanCentral SAST and Debricked Scan
        uses: fortify/github-action@v3
        env:
          SSC_URL: ${{ vars.SSC_URL }}
          SSC_TOKEN: ${{ secrets.SSC_TOKEN }}
          SC_SAST_TOKEN: ${{ secrets.SC_SAST_TOKEN }}
          AVIATOR_URL: ${{ vars.AVIATOR_URL }}
          AVIATOR_TOKEN: ${{ secrets.AVIATOR_TOKEN }}
          DEBRICKED_ACCESS_TOKEN: ${{ secrets.DEBRICKED_ACCESS_TOKEN }}
          SC_CLIENT_VERSION: ${{ vars.SC_CLIENT_VERSION }}
          #SSC:APPVERSION and SSC_PARENT_APPVERSION are set in the Prepare job and passed via needs
          SAST_WAIT_EXTRA_OPTS: --timeout 2h # increase default timeout for waiting for SAST scan to finish, as SAST scans can sometimes take a long time
          DO_SETUP: true
          DO_SAST_SCAN: true
          DO_DEBRICKED_SCAN: true
          DO_AVIATOR_AUDIT: true
          #AVIATOR_APP is set in the Prepare job and passed via needs
          DO_WAIT: true
          DO_APPVERSION_SUMMARY: true
          DO_POLICY_CHECK: false  # we will do policy check in a separate job after DAST scan
          DO_JOB_SUMMARY: true
          DO_PR_COMMENT: true
          DO_EXPORT: true

  #
  # The ScanCentral-DAST-Scan job runs the ScanCentral DAST scan using the fcli command line tool. It is only triggered
  # if the workflow was triggered by a push to the default branch and the corresponding input is set to true. It uses the
  # environment variables set in the Prepare job to determine the application version names in SSC, and it also passes
  # the necessary tokens for authentication to SSC. The scan is configured to wait for completion before allowing the
  # workflow to proceed to the policy check step.
  ScanCentral-DAST-Scan:
    runs-on: ubuntu-latest
    if: ${{ (github.ref_name == github.event.repository.default_branch) && (github.event.inputs.runScanCentralDASTScan == 'true') }}
    needs: [ Prepare, ScanCentral-SAST-Scan ]
    env:
      SSC_APPVERSION: ${{ needs.Prepare.outputs.SSC_APPVERSION }}
      SSC_PARENT_APPVERSION: ${{ needs.Prepare.outputs.SSC_PARENT_APPVERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Fortify tools
        uses: fortify/github-action/setup@v3
        with:
          export-path: true
          fcli: latest
      - name: Run ScanCentral DAST Scan
        shell: bash
        run: |
          fcli ssc session login --url $SSC_URL -t $SSC_TOKEN --ssc-session github-actions
          fcli sc-dast scan start --settings "${SCDAST_SETTINGS_ID}" --store curScan --ssc-session github-actions
          sleep 10
          fcli sc-dast scan wait-for ::curScan:: --ssc-session github-actions
          fcli ssc session logout --ssc-session github-actions
        env:
          SSC_URL: ${{ vars.SSC_URL }}
          SSC_TOKEN: ${{ secrets.SSC_TOKEN }}
          #SSC:APPVERSION and SSC_PARENT_APPVERSION are set in the Prepare job and passed via needs
          SCDAST_SETTINGS_ID: ${{ vars.SCDAST_SETTINGS_ID }}

  #
  # The Verify-Security-Policy job runs the policy check using the fortify/github-action@v3 action. It is triggered for
  # both push and pull request events (as well as manually via workflow_dispatch) if the corresponding input is set to
  # true, but it only runs after the ScanCentral-SAST-Scan job has completed (regardless of success or failure) to ensure
  # that the policy check evaluates the results of the SAST scan and DAST scan (if it was triggered). It uses the
  # environment variables set in the Prepare job to determine the application version names in SSC, and it also passes
  # the necessary token for authentication to SSC. The policy check is configured to not fail the job if the policy check
  # fails, as this allows for reporting of policy violations without necessarily blocking the workflow (e.g. in a PR
  # pipeline you may want to report policy violations but still allow merging if there are other mitigating factors).
  Verify-Security-Policy:
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: [ Prepare, ScanCentral-SAST-Scan ]
    env:
      SSC_APPVERSION: ${{ needs.Prepare.outputs.SSC_APPVERSION }}
      SSC_PARENT_APPVERSION: ${{ needs.Prepare.outputs.SSC_PARENT_APPVERSION }}
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Wait for ScanCentral-DAST-Scan to finish (if it started)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # This script polls the GitHub Actions API to check for the status of the FoD-DAST-Scan job in the current workflow run.
          # It waits until the job is no longer in progress before allowing the workflow to continue to the policy check step. 
          # This ensures that the policy check evaluates the results of the DAST scan if it was triggered.
          set -euo pipefail
          API="https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs"
          echo "Looking for job named 'ScanCentral-DAST-Scan' in this workflow run..."
          # install jq if missing
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y && sudo apt-get install -y jq
          fi
          # poll for the job status (max ~30 minutes)
          max_attempts=180
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt+1))
            job_json=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "$API")
            job_exists=$(echo "$job_json" | jq '.jobs[]? | select(.name=="ScanCentral-DAST-Scan")' || true)
            if [ -z "$job_exists" ] || [ "$job_exists" = "null" ]; then
              echo "No ScanCentral-DAST-Scan job found for this run. Proceeding."
              break
            fi
            status=$(echo "$job_json" | jq -r '.jobs[] | select(.name=="ScanCentral-DAST-Scan") | .status')
            conclusion=$(echo "$job_json" | jq -r '.jobs[] | select(.name=="ScanCentral-DAST-Scan") | .conclusion')
            echo "ScanCentral-DAST-Scan status: $status, conclusion: $conclusion"
            if [ "$status" = "completed" ]; then
              echo "ScanCentral-DAST-Scan completed (conclusion: $conclusion). Continuing."
              break
            fi
            echo "Waiting for ScanCentrla-DAST-Scan to finish... (attempt $attempt)"
            sleep 10
          done
          if [ $attempt -ge $max_attempts ]; then
            echo "Timed out waiting for ScanCentral-DAST-Scan; continuing anyway."
          fi
      - name: Run Check Policy Action
        continue-on-error: true # only for reporting, do not fail the job if policy check fails
        uses: fortify/github-action@v3
        env:
          SSC_URL: ${{ vars.SSC_URL }}
          SSC_TOKEN: ${{ secrets.SSC_TOKEN }}
          #SSC:APPVERSION and SSC_PARENT_APPVERSION are set in the Prepare job and passed via needs
          DO_SETUP: false
          DO_SAST_SCAN: false
          DO_POLICY_CHECK: true
          DO_JOB_SUMMARY: false
          DO_PR_COMMENT: true
          DO_EXPORT: true