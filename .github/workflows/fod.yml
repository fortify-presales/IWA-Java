
# Create GitHub Action Repository Variables for your version of the application:
#   FOD_URL                     - FoD Portal URL for your tenant (e.g. https://ams.fortify.com)
#   FOD_API_URL                 - FoD API URL for your tenant (e.g. https://api.ams,fortify.com)
#   FOD_APP_NAME_POSTFIX        - A postfix string to apply to the application to make it unique, set to empty to use DEFAULT_APP_NAME
#   FOD_DEFAULT_OWNER           - The user id of the Application Owner (only needed if an application does not already exist)
#   FOD_DEFAULT_ASSESSMENT_TYPE - The default Assessment Type to use, e.g. "Static Assessment"
# Create GitHub Action Secrets for your version of the application:
#   FOD_CLIENT_ID should be an API Key obtained from your FoD tenant.
#   FOD_CLIENT_SECRET should be the secret for the API Key obtained for your FoD tenant.
# Helpful hints:
#   API Key credentials can be obtained from your FoD tenant, under Administration -> Settings -> API
#   It is recommended to create credentials with 'Security Lead' Role selected.
#   "Automated Audit preference" should be configured for the release's Static Scan Settings.
name: Security Scan with OpenText Application Security (FoD)

# Set default permissions for the GITHUB_TOKEN
permissions:
  contents: read
  pull-requests: write

on:
  # Triggers the workflow on push or pull request events but only for the main or develop branches
  push:
    paths-ignore:
      - '.github/**/**'
      - 'Jenkinsfile'
      - '.gitlab-ci.yml'
      - 'azure-pipelines.yml'
      - 'bin/**'
      - 'data/**'
      - 'etc/**'
      - 'tests/**'
      - '*.md'
      - 'LICENSE'
    branches:
      - main
      - develop
      - feature/**    # runs on any branch named feature/...
      - bugfix/**     # runs on any branch named bugfix/...
  pull_request:
    branches:
      - main
      - develop

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      runFoDSASTScan:
        description: 'Carry out SAST scan using Fortify on Demand'
        required: false
        default: 'true'
      deployApp:
        description: 'Deploy App'
        required: false
        default: 'true'   
      runFoDDASTScan:
        description: 'Carry out DAST scan using Fortify on Demand'
        required: false
        default: 'false'     

# Global environment variables
env:
  DEFAULT_APP_NAME: "IWA-Java"
  DEFAULT_PARENT_RELEASE_NAME: "main"
  GRADLE_VERSION: "7.6.4"
  JAVA_VERSION: "17"
  BASE_DIR: "."

jobs:

  Env-Prepare:
    runs-on: ubuntu-latest
    outputs:
      FOD_RELEASE: ${{ steps.commands.outputs.FOD_RELEASE }}
      FOD_PARENT_RELEASE: ${{ steps.commands.outputs.FOD_PARENT_RELEASE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up environment variables
        id: commands
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "Running in a pull request pipeline ..."
            echo "FOD_RELEASE=${{ env.DEFAULT_APP_NAME }}${{ vars.FOD_APP_NAME_POSTFIX }}:merge-to-${{ github.base_ref }}#PR${{ github.event.number }}" >> $GITHUB_OUTPUT
            echo "FOD_PARENT_RELEASE=${{ env.DEFAULT_APP_NAME }}${{ vars.FOD_APP_NAME_POSTFIX }}:${{ github.head_ref }}" >> $GITHUB_OUTPUT
          else
            echo "Running in a branch pipeline ..."
            echo "FOD_RELEASE=${{ env.DEFAULT_APP_NAME }}${{ vars.FOD_APP_NAME_POSTFIX }}:${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "FOD_PARENT_RELEASE=${{ env.DEFAULT_APP_NAME }}${{ vars.FOD_APP_NAME_POSTFIX }}:${{ env.DEFAULT_PARENT_RELEASE_NAME }}" >> $GITHUB_OUTPUT
          fi 

  FoD-SAST-Scan:
    runs-on: ubuntu-latest
    if: ${{ (github.event_name == 'push') || (github.event_name == 'pull_request') || (github.event.inputs.runFoDSASTScan == 'true') }}
    needs: [ Env-Prepare ]
    env: 
      FOD_RELEASE: ${{ needs.Env-Prepare.outputs.FOD_RELEASE }}
      FOD_PARENT_RELEASE: ${{ needs.Env-Prepare.outputs.FOD_PARENT_RELEASE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      # Setup JDK 17 on host
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      #
      # See: https://github.com/marketplace/actions/fortify-ast-scan
      #
      - name: Run Fortify on Demand SAST Scan
        uses: fortify/github-action@v2
        with:
          sast-scan: true
          debricked-sca-scan: true
        env:
          FOD_URL: ${{ vars.FOD_URL }}
          #FOD_TENANT: ${{secrets.FOD_TENANT}}
          #FOD_USER: ${{secrets.FOD_USER}}
          #FOD_PASSWORD: ${{secrets.FOD_PAT}}
          FOD_CLIENT_ID: ${{secrets.FOD_CLIENT_ID}}
          FOD_CLIENT_SECRET: ${{secrets.FOD_CLIENT_SECRET}}
          # FOD_LOGIN_EXTRA_OPTS: --socket-timeout=60s
          #FOD_RELEASE: ${{ format('{0}{1}:{2}', env.DEFAULT_APP_NAME, vars.FORTIFY_APP_NAME_POSTFIX, github.ref_name) }}
          DO_SETUP: true
          SETUP_EXTRA_OPTS: ${{ format('--copy-from "{0}" --sdlc-status Development --app-owner {1} --assessment-type "{2}"', env.FOD_PARENT_RELEASE, vars.FOD_DEFAULT_OWNER, vars.FOD_DEFAULT_ASSESSMENT_TYPE) }}
          PACKAGE_EXTRA_OPTS: -bt gradle -bf build.gradle -bc "clean build -x test" -oss
          # FOD_SAST_SCAN_EXTRA_OPTS:
          DO_WAIT: true
          DO_POLICY_CHECK: false  # we will do policy check in a separate job after DAST scan
          DO_JOB_SUMMARY: true
          DO_PR_COMMENT: true
          DO_EXPORT: true

  FoD-DAST-Scan:
    runs-on: ubuntu-latest
    if: ${{ (github.ref_name == github.event.repository.default_branch) && (github.event.inputs.runFoDDASTScan == 'true') }}
    needs: [ Env-Prepare, FoD-SAST-Scan ]
    env: 
      FOD_RELEASE: ${{ needs.Env-Prepare.outputs.FOD_RELEASE }}
      FOD_PARENT_RELEASE: ${{ needs.Env-Prepare.outputs.FOD_PARENT_RELEASE }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Fortify tools
        uses: fortify/github-action/setup@v2
        with:
          #tool-definitions: https://github.com/fortify/tool-definitions/releases/download/v1/tool-definitions.yaml.zip
          export-path: true
          fcli: latest
      - name: Check FoD Release
        shell: bash
        run: |
          fcli fod session login --url $FOD_API_URI --client-id $FOD_CLIENT_ID --client-secret $FOD_CLIENT_SECRET --fod-session github-actions
          fcli fod dast-scan start --release "${FOD_RELEASE}" --store curScan --fod-session github-actions
          sleep 10
          fcli fod dast-scan wait-for ::curScan:: --fod-session github-actions
          fcli fod session logout --fod-session github-actions
        env:
          FOD_API_URI: ${{ vars.FOD_API_URL }}
          FOD_CLIENT_ID: ${{ secrets.FOD_CLIENT_ID }}
          FOD_CLIENT_SECRET: ${{ secrets.FOD_CLIENT_SECRET }}
          FOD_RELEASE: ${{ env.FOD_RELEASE }}

  Verify-Security-Policy:
    runs-on: ubuntu-latest
    if: ${{ always() }}
    needs: [ Env-Prepare, FoD-SAST-Scan ]
    env:
      FOD_RELEASE: ${{ needs.Env-Prepare.outputs.FOD_RELEASE }}
      FOD_PARENT_RELEASE: ${{ needs.Env-Prepare.outputs.FOD_PARENT_RELEASE }}
    continue-on-error: true
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Wait for FoD-DAST-Scan to finish (if it started)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          API="https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs"
          echo "Looking for job named 'FoD-DAST-Scan' in this workflow run..."
          # install jq if missing
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y && sudo apt-get install -y jq
          fi
          # poll for the job status (max ~30 minutes)
          max_attempts=180
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            attempt=$((attempt+1))
            job_json=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" "$API")
            job_exists=$(echo "$job_json" | jq '.jobs[]? | select(.name=="FoD-DAST-Scan")' || true)
            if [ -z "$job_exists" ] || [ "$job_exists" = "null" ]; then
              echo "No FoD-DAST-Scan job found for this run. Proceeding."
              break
            fi
            status=$(echo "$job_json" | jq -r '.jobs[] | select(.name=="FoD-DAST-Scan") | .status')
            conclusion=$(echo "$job_json" | jq -r '.jobs[] | select(.name=="FoD-DAST-Scan") | .conclusion')
            echo "FoD-DAST-Scan status: $status, conclusion: $conclusion"
            if [ "$status" = "completed" ]; then
              echo "FoD-DAST-Scan completed (conclusion: $conclusion). Continuing."
              break
            fi
            echo "Waiting for FoD-DAST-Scan to finish... (attempt $attempt)"
            sleep 10
          done
          if [ $attempt -ge $max_attempts ]; then
            echo "Timed out waiting for FoD-DAST-Scan; continuing anyway."
          fi

      - name: Run Fortify on Demand SAST Scan
        uses: fortify/github-action@v2
        with:
          sast-scan: false
          debricked-sca-scan: false
        env:
          FOD_URL: ${{ vars.FOD_URL }}
          FOD_CLIENT_ID: ${{secrets.FOD_CLIENT_ID}}
          FOD_CLIENT_SECRET: ${{secrets.FOD_CLIENT_SECRET}}
          DO_SETUP: false
          DO_WAIT: false
          DO_POLICY_CHECK: true
          DO_JOB_SUMMARY: false
          DO_PR_COMMENT: true
          DO_EXPORT: true
